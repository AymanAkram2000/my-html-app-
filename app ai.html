<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النظام المحاسبي - أ. مصطفى الجندي</title>
    <!-- Tailwind CSS with Typography plugin for Markdown rendering -->
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (XLSX) for Excel Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .modal { display: none; transition: opacity 0.3s ease; }
        .modal.is-open { display: flex; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
        .file-input-button { cursor: pointer; display: inline-block; padding: 0.5rem 1rem; }
        .dropdown-menu { display: none; }
        .dropdown-menu.is-active { display: block; }
        .hidden-transition {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
        }
        .visible-transition {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
    </style>
</head>
<body class="text-stone-800">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-80 z-[100] flex-col gap-4 items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-cyan-600"></div>
        <p id="loader-text" class="text-lg font-semibold text-cyan-700">جاري التحميل...</p>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal is-open fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 text-center">
            <h3 class="text-2xl font-bold mb-2">تسجيل الدخول</h3>
            <p class="text-stone-500 mb-6">الرجاء إدخال كلمة المرور للوصول للنظام.</p>
            <form id="login-form">
                <input type="password" id="password" placeholder="كلمة المرور" class="w-full text-center p-3 border border-stone-300 rounded-lg mb-4 focus:ring-2 focus:ring-cyan-500">
                <button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700 transition-colors">دخول</button>
                <p id="login-error" class="text-red-500 mt-4 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="min-h-screen hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center flex-wrap gap-3">
                <h1 class="text-2xl font-bold text-cyan-700">النظام المحاسبي</h1>
                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                    <button id="show-dashboard-btn" class="px-3 py-1 rounded-md">لوحة التحكم</button>
                    <button id="show-transactions-btn" class="px-3 py-1 rounded-md">إدارة العمليات</button>
                    <button id="show-book-report-btn" class="px-3 py-1 rounded-md">تقرير الكتب</button>
                    <button id="settings-btn" title="الإعدادات" class="px-3 py-2 rounded-lg hover:bg-stone-100"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                    <div id="add-op-dropdown" class="relative">
                        <button id="add-op-dropdown-btn" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 shadow-md flex items-center gap-2">+ إضافة عملية <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                        <div id="add-op-dropdown-menu" class="dropdown-menu absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="#" id="open-add-print-modal-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">عملية طباعة كتاب</a>
                            <a href="#" id="open-add-withdrawal-modal-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">سحب نقدي</a>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 md:p-6">
             <!-- Filter Bar -->
            <div class="bg-white p-3 rounded-xl shadow-lg mb-6">
                <div class="flex items-center gap-2 md:gap-4 flex-wrap">
                    <label for="date-filter" class="font-bold">عرض تقرير:</label>
                    <select id="date-filter" class="p-2 border border-stone-300 rounded-lg">
                        <option value="all_time" selected>كل الوقت</option>
                        <option value="this_month">هذا الشهر</option>
                        <option value="last_month">الشهر الماضي</option>
                        <option value="last_3_months">آخر 3 أشهر</option>
                        <option value="this_year">هذه السنة</option>
                        <option value="last_year">السنة الماضية</option>
                        <option value="custom">فترة مخصصة</option>
                    </select>
                    <button id="export-btn" title="تصدير التقرير الحالي إلى Excel" class="px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                    <label for="import-file" title="استيراد بيانات جديدة" class="file-input-button px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></label>
                    <input type="file" id="import-file" class="hidden" accept=".xlsx, .xls">
                    <button id="analyze-report-btn" title="الحصول على تحليل ذكي للتقرير الحالي" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:from-purple-600 hover:to-indigo-700 shadow-md transition-all">
                        ✨
                        <span>تحليل ذكي</span>
                    </button>
                </div>
                 <!-- Custom Date Range Picker -->
                <div id="custom-date-range" class="hidden-transition mt-4 space-y-3 md:space-y-0 md:flex md:items-center md:gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-stone-600">من تاريخ:</label>
                        <input type="date" id="start-date" class="p-2 border border-stone-300 rounded-lg w-full md:w-auto">
                    </div>
                     <div>
                        <label for="end-date" class="block text-sm font-medium text-stone-600">إلى تاريخ:</label>
                        <input type="date" id="end-date" class="p-2 border border-stone-300 rounded-lg w-full md:w-auto">
                    </div>
                </div>
            </div>

            <div id="dashboard-view">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                     <div class="bg-white p-6 rounded-xl shadow-lg border-r-4 border-green-500"><h3 class="text-stone-500 text-lg">إجمالي الأرباح (طباعة)</h3><p id="total-credit" class="text-3xl font-black text-green-600 mt-2">0.00</p></div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border-r-4 border-red-500"><h3 class="text-stone-500 text-lg">إجمالي المسحوبات</h3><p id="total-debit" class="text-3xl font-black text-red-600 mt-2">0.00</p></div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border-r-4 border-cyan-500"><h3 class="text-stone-500 text-lg">الرصيد النهائي للحساب</h3><p id="final-balance" class="text-3xl font-black text-cyan-600 mt-2">0.00</p></div>
                 </div>
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                     <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg"><h3 class="font-bold text-xl mb-4">ملخص الأرباح والمسحوبات</h3><canvas id="balance-chart"></canvas></div>
                     <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg"><h3 class="font-bold text-xl mb-4">أهم الكتب (حسب الأرباح)</h3><canvas id="top-items-chart"></canvas></div>
                 </div>
            </div>

            <div id="transactions-view" class="hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">سجل العمليات للفترة المحددة</h2>
                    <div class="overflow-x-auto"><table class="w-full text-right"><thead class="bg-stone-100"><tr><th class="p-3">التاريخ</th><th class="p-3">البيان</th><th class="p-3">النوع</th><th class="p-3">له (أرباح)</th><th class="p-3">عليه (مسحوبات)</th><th class="p-3">إجراءات</th></tr></thead><tbody id="transactions-table-body"></tbody></table></div>
                 </div>
            </div>
            
            <div id="book-report-view" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                   <h2 class="text-2xl font-bold mb-4">تقرير كميات الكتب المطبوعة</h2>
                   <div class="mb-4">
                        <label for="book-search" class="font-bold mr-2">ابحث عن كتاب:</label>
                        <input type="text" id="book-search" placeholder="اكتب اسم الكتاب هنا..." class="p-2 border border-stone-300 rounded-lg w-full md:w-1/2">
                   </div>
                   <div class="overflow-x-auto">
                       <table class="w-full text-right">
                           <thead class="bg-stone-100">
                               <tr>
                                   <th class="p-3">اسم الكتاب</th>
                                   <th class="p-3">إجمالي النسخ المطبوعة</th>
                                   <th class="p-3">إجمالي الأرباح</th>
                               </tr>
                           </thead>
                           <tbody id="book-report-table-body">
                           </tbody>
                       </table>
                   </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="change-password-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative"><button class="close-modal-btn absolute top-4 left-4 text-stone-500 hover:text-red-600 text-3xl">&times;</button><h3 class="text-2xl font-bold mb-4">تغيير كلمة المرور</h3><form id="change-password-form" class="space-y-4"><div><label class="block mb-1 font-bold">كلمة المرور القديمة</label><input type="password" id="old-password" required class="w-full p-2 border rounded-lg"></div><div><label class="block mb-1 font-bold">كلمة المرور الجديدة</label><input type="password" id="new-password" required class="w-full p-2 border rounded-lg"></div><div><label class="block mb-1 font-bold">تأكيد الجديدة</label><input type="password" id="confirm-new-password" required class="w-full p-2 border rounded-lg"></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn bg-stone-200 py-2 px-6 rounded-lg">إلغاء</button><button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">حفظ</button></div></form></div></div>
    <div id="add-print-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative"><button class="close-modal-btn absolute top-4 left-4 text-stone-500 hover:text-red-600 text-3xl leading-none">&times;</button><h3 id="print-modal-title" class="text-2xl font-bold mb-4">إضافة عملية طباعة</h3><form id="add-print-form" class="space-y-4"><input type="hidden" id="edit-print-id"><div class="flex gap-4"><div class="flex-grow"><label class="block mb-1 font-bold">اسم الكتاب</label><select id="item-select" required class="w-full p-2 border rounded-lg"></select></div><button type="button" id="open-add-item-modal-btn" class="self-end bg-stone-200 text-stone-700 font-bold py-2 px-3 rounded-lg">+</button></div><div><label class="block mb-1 font-bold">التاريخ</label><input type="date" id="print-date" required class="w-full p-2 border rounded-lg"></div><div class="grid grid-cols-2 gap-4"><div><label class="block mb-1 font-bold">الكمية المطبوعة</label><input type="number" id="quantity" value="0" min="0" class="w-full p-2 border rounded-lg"></div><div><label class="block mb-1 font-bold">سعر الوحدة (ربح)</label><input type="number" id="unit-price" value="0" min="0" step="0.01" class="w-full p-2 border rounded-lg"></div></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn bg-stone-200 py-2 px-6 rounded-lg">إلغاء</button><button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">حفظ</button></div></form></div></div>
    <div id="add-item-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative"><button class="close-modal-btn absolute top-4 left-4 text-stone-500 hover:text-red-600 text-3xl">&times;</button><h3 class="text-2xl font-bold mb-4">إضافة كتاب جديد</h3><form id="add-item-form" class="space-y-4"><div><label class="block mb-1 font-bold">اسم الكتاب</label><input type="text" id="new-item-name" required class="w-full p-2 border rounded-lg"></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn bg-stone-200 py-2 px-6 rounded-lg">إلغاء</button><button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">حفظ</button></div></form></div></div>
    <div id="add-withdrawal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative"><button class="close-modal-btn absolute top-4 left-4 text-stone-500 hover:text-red-600 text-3xl">&times;</button><h3 id="withdrawal-modal-title" class="text-2xl font-bold mb-4">إضافة سحب نقدي</h3><form id="add-withdrawal-form" class="space-y-4"><input type="hidden" id="edit-withdrawal-id"><div><label class="block mb-1 font-bold">التاريخ</label><input type="date" id="withdrawal-date" required class="w-full p-2 border rounded-lg"></div><div><label class="block mb-1 font-bold">المبلغ المسحوب</label><input type="number" id="withdrawal-amount" required min="0" step="0.01" class="w-full p-2 border rounded-lg"></div><div><label class="block mb-1 font-bold">ملاحظات</label><textarea id="withdrawal-notes" rows="3" class="w-full p-2 border rounded-lg"></textarea></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn bg-stone-200 py-2 px-6 rounded-lg">إلغاء</button><button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">حفظ</button></div></form></div></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center"><h3 id="confirm-title" class="text-xl font-bold mb-4"></h3><p id="confirm-text" class="text-stone-600 mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="bg-stone-200 py-2 px-6 rounded-lg">إلغاء</button><button id="confirm-ok-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">تأكيد</button></div></div></div>
    
    <div id="analysis-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative">
            <button class="close-modal-btn absolute top-4 left-4 text-stone-500 hover:text-red-600 text-3xl leading-none">&times;</button>
            <div id="analysis-content-wrapper">
                 <h3 class="text-2xl font-bold mb-4 text-purple-700 flex items-center gap-3">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c-1.2 0-2.4.6-3 1.7A3.5 3.5 0 0 0 5 8.5c0 1.4.8 2.6 2 3.2V21a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-9.3c1.2-.6 2-1.8 2-3.2A3.5 3.5 0 0 0 15 5c-.6-1.1-1.8-1.7-3-1.7Z"/><path d="m14 14-2 2-2-2"/></svg>
                    <span>تحليل التقرير الذكي</span>
                </h3>
                <div id="analysis-loader" class="text-center py-10">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mx-auto"></div>
                    <p class="mt-4 text-stone-600">يقوم الذكاء الاصطناعي بتحليل بياناتك... الرجاء الانتظار.</p>
                </div>
                <div id="analysis-result" class="hidden prose prose-lg max-w-none text-right prose-headings:text-stone-800 prose-headings:font-bold prose-li:marker:text-purple-500"></div>
            </div>
            <div class="flex justify-end gap-4 pt-4 mt-4 border-t">
                <button type="button" class="cancel-btn bg-stone-200 py-2 px-6 rounded-lg hover:bg-stone-300">إغلاق</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- State ---
        let allItems = [];
        let allOperations = [];
        let balanceChartInstance, topItemsChartInstance;

        // --- DOM Elements ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const app = {
            loader: $('#loader'),
            loaderText: $('#loader-text'),
            loginModal: $('#login-modal'),
            appContainer: $('#app'),
            modals: {
                print: $('#add-print-modal'),
                item: $('#add-item-modal'),
                withdrawal: $('#add-withdrawal-modal'),
                password: $('#change-password-modal'),
                confirm: $('#confirm-modal'),
                analysis: $('#analysis-modal')
            },
            forms: {
                login: $('#login-form'),
                print: $('#add-print-form'),
                item: $('#add-item-form'),
                withdrawal: $('#add-withdrawal-form'),
                password: $('#change-password-form')
            },
            dropdownMenu: $('#add-op-dropdown-menu'),
            customDateRange: $('#custom-date-range'),
            dateFilter: $('#date-filter'),
            bookSearchInput: $('#book-search'),
        };

        // --- Core Functions ---
        const showLoader = (text = 'جاري التحميل...') => { app.loaderText.textContent = text; app.loader.style.display = 'flex'; };
        const hideLoader = () => { app.loader.style.display = 'none'; };
        const formatCurrency = (num) => new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(num || 0);
        const openModal = (modal) => modal.classList.add('is-open');
        const closeModal = (modal) => modal.classList.remove('is-open');
        const closeAllModals = () => Object.values(app.modals).forEach(closeModal);

        // --- Persistence ---
        const getPassword = () => localStorage.getItem('pub_pass') || '123';
        const setPassword = (newPass) => localStorage.setItem('pub_pass', newPass);
        const saveData = () => {
            localStorage.setItem('pub_items', JSON.stringify(allItems));
            localStorage.setItem('pub_ops', JSON.stringify(allOperations));
        };
        const loadData = () => {
            allItems = JSON.parse(localStorage.getItem('pub_items')) || [];
            allOperations = JSON.parse(localStorage.getItem('pub_ops')) || [];
        };
        
        const refreshFilteredUI = () => {
            const filteredOps = getOperationsByPeriod();
            renderOperations(filteredOps);
            updateDashboard(filteredOps);
            renderBookReport(); 
            populateItemsDropdown();
        };

        const recalculateAllData = () => {
            showLoader("جاري إعادة حساب الأرصدة...");
            allOperations.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let runningBalance = 0;
            allOperations.forEach(op => {
                op.openingBalance = runningBalance;
                op.amount = parseFloat(op.amount) || 0;
                if (op.type === 'print') {
                    runningBalance += op.amount;
                } else if (op.type === 'withdrawal') {
                    runningBalance -= op.amount;
                }
                op.closingBalance = runningBalance;
            });
            
            allItems.forEach(item => { item.totalQuantity = 0; item.totalAmount = 0; });
            allOperations.filter(op => op.type === 'print').forEach(op => {
                const item = allItems.find(i => i.id === op.itemId);
                if(item){
                    item.totalQuantity += (op.quantity || 0);
                    item.totalAmount += (op.amount || 0);
                }
            });
            
            saveData();
            refreshFilteredUI();
            hideLoader();
        };

        // --- Gemini API Integration ---
        const getFinancialAnalysis = async () => {
            const analysisModal = app.modals.analysis;
            const loader = $('#analysis-loader');
            const resultDiv = $('#analysis-result');
            
            loader.style.display = 'block';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            openModal(analysisModal);

            const currentOps = getOperationsByPeriod();
            if (currentOps.length === 0) {
                 resultDiv.innerHTML = `<p class="text-center text-stone-600">لا توجد بيانات كافية في الفترة المحددة لإنشاء تحليل.</p>`;
                 loader.style.display = 'none';
                 resultDiv.style.display = 'block';
                 return;
            }

            const totalCredit = currentOps.filter(o => o.type === 'print').reduce((sum, o) => sum + o.amount, 0);
            const totalDebit = currentOps.filter(o => o.type === 'withdrawal').reduce((sum, o) => sum + o.amount, 0);
            const finalBalance = totalCredit - totalDebit;

            const itemSummary = {};
            currentOps.filter(o => o.type === 'print').forEach(o => {
                const itemName = allItems.find(i => i.id === o.itemId)?.name || 'كتاب محذوف';
                if (!itemSummary[itemName]) itemSummary[itemName] = 0;
                itemSummary[itemName] += o.amount;
            });

            const topItems = Object.entries(itemSummary)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5)
                .map(([name, amount]) => `${name} (أرباح: ${formatCurrency(amount)})`)
                .join('، ');

            const periodText = app.dateFilter.options[app.dateFilter.selectedIndex].text;

            const prompt = `You are a financial advisor for a small book printing business. Analyze the following financial summary for the period "${periodText}" and provide a concise, insightful report in Arabic. The report should be encouraging and professional, formatted in Markdown with headings, subheadings, and bullet points.

            Financial Data:
            - Total Profits (from printing): ${formatCurrency(totalCredit)}
            - Total Withdrawals: ${formatCurrency(totalDebit)}
            - Net Balance: ${formatCurrency(finalBalance)}
            - Top 5 Most Profitable Books: ${topItems || 'لا يوجد'}

            Based on this data, please provide:
            1.  A main heading "## تحليل الأداء المالي"
            2.  Under that, a subheading "### نظرة عامة" with a brief overview of the financial performance.
            3.  Another subheading "### ملاحظات رئيسية" with bullet points on key observations or trends (e.g., profitability of certain books, relationship between profits and withdrawals).
            4.  A final subheading "### توصيات" with one or two actionable recommendations for the business owner.
            
            Your entire response must be in Arabic and use Markdown for formatting.`;
            
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyDUCp9vhp5JMw_1rA14GnJS5Ab5NN_vf0M"; // API Key updated here
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                
                let analysisText = "لم يتمكن الذكاء الاصطناعي من إنشاء تحليل. الرجاء المحاولة مرة أخرى.";
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                  analysisText = result.candidates[0].content.parts[0].text;
                } else {
                     console.error("Unexpected API response structure:", result);
                }
                
                resultDiv.innerHTML = analysisText;

            } catch (error) {
                console.error('Error fetching from Gemini API:', error);
                resultDiv.innerHTML = `<p class="text-red-500">حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. الرجاء التأكد من اتصالك بالإنترنت والمحاولة مرة أخرى. (${error.message})</p>`;
            } finally {
                loader.style.display = 'none';
                resultDiv.style.display = 'block';
            }
        };

        // --- Business Logic ---
        const addOrUpdateOperation = (data, type) => {
            const isEdit = data.id && data.id.trim() !== '';
            if (isEdit) {
                const index = allOperations.findIndex(op => op.id === data.id);
                if (index > -1) {
                    const updatedOp = { ...allOperations[index], ...data };
                    if (type === 'print') {
                        updatedOp.amount = (updatedOp.quantity || 0) * (updatedOp.unitPrice || 0);
                    }
                    allOperations[index] = updatedOp;
                } else {
                    alert("خطأ في التعديل: لم يتم العثور على العملية الأصلية.");
                    return; 
                }
            } else {
                allOperations.push({ ...data, id: `OP_${new Date().getTime()}`, type: type, amount: type === 'print' ? ((data.quantity || 0) * (data.unitPrice || 0)) : (data.amount || 0) });
            }
            recalculateAllData();
            closeAllModals();
        };

        const deleteOperation = (id) => {
            showConfirmation("تأكيد الحذف", "هل أنت متأكد من حذف هذه العملية؟ سيتم إعادة حساب جميع الأرصدة.", () => {
                allOperations = allOperations.filter(op => op.id !== id);
                recalculateAllData();
            });
        };

        const addItem = (itemName) => {
            if (!itemName?.trim()) return alert("اسم الكتاب لا يمكن أن يكون فارغاً.");
            if (allItems.some(item => item.name.trim().toLowerCase() === itemName.trim().toLowerCase())) return alert("هذا الكتاب موجود بالفعل.");
            allItems.push({ id: `ITEM_${new Date().getTime()}`, name: itemName.trim(), totalQuantity: 0, totalAmount: 0 });
            saveData();
            alert('تمت إضافة الكتاب بنجاح!');
            closeModal(app.modals.item);
            app.forms.item.reset();
            populateItemsDropdown();
        };

        // --- UI Rendering ---
        const renderOperations = (ops) => {
            const tbody = $('#transactions-table-body');
            tbody.innerHTML = '';
            if (ops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-stone-500">لا توجد عمليات لهذه الفترة.</td></tr>';
                return;
            }
            [...ops].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(op => {
                const isPrint = op.type === 'print';
                const row = `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="p-3">${op.date}</td>
                        <td class="p-3 font-bold">${isPrint ? (allItems.find(i => i.id === op.itemId)?.name || 'كتاب محذوف') : (op.notes || 'سحب نقدي')}</td>
                        <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${isPrint ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isPrint ? 'طباعة' : 'سحب'}</span></td>
                        <td class="p-3 text-green-600 font-semibold">${isPrint ? formatCurrency(op.amount) : '-'}</td>
                        <td class="p-3 text-red-600 font-semibold">${!isPrint ? formatCurrency(op.amount) : '-'}</td>
                        <td class="p-3">
                            <button class="edit-btn p-1 text-blue-500 hover:text-blue-700" data-id="${op.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="delete-btn p-1 text-red-500 hover:text-red-700" data-id="${op.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                        </td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        };
        
        const renderBookReport = () => {
            const tbody = $('#book-report-table-body');
            const searchTerm = app.bookSearchInput.value.toLowerCase().trim();
            const opsForPeriod = getOperationsByPeriod().filter(op => op.type === 'print');

            let booksToReportOn = allItems;
            if (searchTerm) {
                booksToReportOn = allItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            }
            
            tbody.innerHTML = '';
            if (booksToReportOn.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-stone-500">لا توجد كتب تطابق بحثك.</td></tr>`;
                 return;
            }

            [...booksToReportOn].sort((a, b) => a.name.localeCompare(b.name, 'ar')).forEach(book => {
                const bookOps = opsForPeriod.filter(op => op.itemId === book.id);
                const totalQuantity = bookOps.reduce((sum, op) => sum + (op.quantity || 0), 0);
                const totalAmount = bookOps.reduce((sum, op) => sum + (op.amount || 0), 0);

                const row = `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="p-3 font-bold">${book.name}</td>
                        <td class="p-3">${totalQuantity}</td>
                        <td class="p-3 text-green-600 font-semibold">${formatCurrency(totalAmount)}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        };

        const updateDashboard = (ops) => {
            const totalCredit = ops.filter(o => o.type === 'print').reduce((sum, o) => sum + o.amount, 0);
            const totalDebit = ops.filter(o => o.type === 'withdrawal').reduce((sum, o) => sum + o.amount, 0);
            const finalBalance = totalCredit - totalDebit;

            $('#total-credit').textContent = formatCurrency(totalCredit);
            $('#total-debit').textContent = formatCurrency(totalDebit);
            $('#final-balance').textContent = formatCurrency(finalBalance);
            $('#final-balance').className = `text-3xl font-black mt-2 ${finalBalance < 0 ? 'text-red-600' : 'text-cyan-600'}`;
            
            const itemSummary = {};
            ops.filter(o => o.type === 'print').forEach(o => {
                const itemName = allItems.find(i => i.id === o.itemId)?.name || 'كتاب محذوف';
                if(!itemSummary[itemName]) itemSummary[itemName] = 0;
                itemSummary[itemName] += o.amount;
            });
            const topItems = Object.entries(itemSummary).sort((a,b) => b[1] - a[1]).slice(0, 5).map(entry => ({name: entry[0], amount: entry[1]}));
            renderTopItemsChart(topItems);
            renderBalanceChart(ops);
        };
        
        const populateItemsDropdown = () => {
            const itemSelect = $('#item-select');
            const currentVal = itemSelect.value;
            itemSelect.innerHTML = '<option value="" disabled selected>اختر كتاباً...</option>';
            [...allItems].sort((a, b) => a.name.localeCompare(b.name, 'ar')).forEach(item => {
                itemSelect.insertAdjacentHTML('beforeend', `<option value="${item.id}">${item.name}</option>`);
            });
            itemSelect.value = currentVal;
        };

        const renderChart = (chartId, instance, type, options) => {
            const ctx = $(`#${chartId}`).getContext('2d');
            if (instance) instance.destroy();
            return new Chart(ctx, { type, ...options });
        };
        
        const renderTopItemsChart = (topItems) => {
            topItemsChartInstance = renderChart('top-items-chart', topItemsChartInstance, 'doughnut', { data: { labels: topItems.map(i => i.name), datasets: [{ data: topItems.map(i => i.amount), backgroundColor: ['#0891b2', '#0e7490', '#155e75', '#164e63', '#27272a'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
        };

        const renderBalanceChart = (ops) => {
            const dataByMonth = {};
            ops.forEach(o => {
                const month = o.date.slice(0, 7);
                if (!dataByMonth[month]) dataByMonth[month] = { credit: 0, debit: 0 };
                if(o.type === 'print') dataByMonth[month].credit += o.amount;
                else dataByMonth[month].debit += o.amount;
            });
            const sortedMonths = Object.keys(dataByMonth).sort();
            const chartData = {
                labels: sortedMonths.map(m => new Date(m + '-02').toLocaleString('ar-EG', { month: 'short', year: 'numeric' })),
                datasets: [
                    { label: 'الأرباح', data: sortedMonths.map(m => dataByMonth[m].credit), borderColor: '#10b981', backgroundColor: '#10b98120', fill: true, tension: 0.3 },
                    { label: 'المسحوبات', data: sortedMonths.map(m => dataByMonth[m].debit), borderColor: '#ef4444', backgroundColor: '#ef444420', fill: true, tension: 0.3 }
                ]
            };
            balanceChartInstance = renderChart('balance-chart', balanceChartInstance, 'line', { data: chartData, options: { responsive: true, scales: { y: { ticks: { callback: v => formatCurrency(v) } } } } });
        };

        const showConfirmation = (title, text, onConfirm) => {
            $('#confirm-title').textContent = title;
            $('#confirm-text').textContent = text;
            const okBtn = $('#confirm-ok-btn');
            
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            newOkBtn.addEventListener('click', () => {
                onConfirm();
                closeModal(app.modals.confirm);
            }, { once: true });
            
            openModal(app.modals.confirm);
        };
        
        const handleLogin = (e) => { e.preventDefault(); if ($('#password').value === getPassword()) { closeModal(app.loginModal); app.appContainer.classList.remove('hidden'); initApp(); } else { $('#login-error').textContent = 'كلمة المرور غير صحيحة.'; } };

        const handleTableClick = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            
            const operation = allOperations.find(op => op.id === id);
            if (!operation) return;

            if (target.classList.contains('edit-btn')) {
                if (operation.type === 'print') {
                    $('#edit-print-id').value = id; $('#item-select').value = operation.itemId; $('#print-date').value = operation.date; $('#quantity').value = operation.quantity; $('#unit-price').value = operation.unitPrice; $('#print-modal-title').textContent = 'تعديل عملية طباعة'; openModal(app.modals.print);
                } else {
                    $('#edit-withdrawal-id').value = id; $('#withdrawal-date').value = operation.date; $('#withdrawal-amount').value = operation.amount; $('#withdrawal-notes').value = operation.notes; $('#withdrawal-modal-title').textContent = 'تعديل سحب نقدي'; openModal(app.modals.withdrawal);
                }
            } else if (target.classList.contains('delete-btn')) {
                 deleteOperation(id);
            }
        };
        
        const getOperationsByPeriod = () => {
            const period = app.dateFilter.value;
            const now = new Date();
            let startDate, endDate = new Date();

            switch(period) {
                case 'all_time': return allOperations;
                case 'this_month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'last_month':
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
                case 'last_3_months': startDate = new Date(new Date(now).setMonth(now.getMonth() - 2)); startDate.setDate(1); break;
                case 'this_year': startDate = new Date(now.getFullYear(), 0, 1); break;
                case 'last_year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                case 'custom':
                    startDate = new Date($('#start-date').value);
                    endDate = new Date($('#end-date').value);
                    if (isNaN(startDate) || isNaN(endDate)) return [];
                    endDate.setHours(23, 59, 59, 999);
                    break;
                default: return allOperations;
            }

            return allOperations.filter(op => {
                const opDate = new Date(op.date);
                return opDate >= startDate && opDate <= endDate;
            });
        };

        const handleDateFilterChange = () => {
            if (app.dateFilter.value === 'custom') {
                app.customDateRange.classList.remove('hidden-transition');
                app.customDateRange.classList.add('visible-transition');
            } else {
                app.customDateRange.classList.add('hidden-transition');
                app.customDateRange.classList.remove('visible-transition');
            }
            refreshFilteredUI();
        };

        // --- Setup & Init ---
        const setupEventListeners = () => {
            app.forms.login.addEventListener('submit', handleLogin);
            
            $('#add-op-dropdown-btn').addEventListener('click', (e) => { e.stopPropagation(); app.dropdownMenu.classList.toggle('is-active'); });
            document.addEventListener('click', (e) => { if (!e.target.closest('#add-op-dropdown')) app.dropdownMenu.classList.remove('is-active'); });
            
            const openModalAction = (modal, form, titleSelector, dateId) => {
                form.reset();
                form.querySelectorAll('input[type=hidden]').forEach(i => i.value = '');
                $(titleSelector).textContent = titleSelector.includes('print') ? 'إضافة عملية طباعة' : 'إضافة سحب نقدي';
                $(dateId).value = new Date().toISOString().split('T')[0];
                app.dropdownMenu.classList.remove('is-active');
                openModal(modal);
            };

            $('#open-add-print-modal-btn').addEventListener('click', () => openModalAction(app.modals.print, app.forms.print, '#print-modal-title', '#print-date'));
            $('#open-add-withdrawal-modal-btn').addEventListener('click', () => openModalAction(app.modals.withdrawal, app.forms.withdrawal, '#withdrawal-modal-title', '#withdrawal-date'));
            $('#open-add-item-modal-btn').addEventListener('click', () => openModal(app.modals.item));
            $('#settings-btn').addEventListener('click', () => { app.forms.password.reset(); openModal(app.modals.password); });
            $$('.close-modal-btn, .cancel-btn, #confirm-cancel-btn').forEach(btn => btn.addEventListener('click', closeAllModals));

            $('#show-dashboard-btn').addEventListener('click', () => switchView('dashboard'));
            $('#show-transactions-btn').addEventListener('click', () => switchView('transactions'));
            $('#show-book-report-btn').addEventListener('click', () => switchView('bookReport'));
            
            app.forms.item.addEventListener('submit', e => { e.preventDefault(); addItem($('#new-item-name').value); });
            app.forms.print.addEventListener('submit', e => { e.preventDefault(); const d = { id: $('#edit-print-id').value, itemId: $('#item-select').value, date: $('#print-date').value, quantity: parseFloat($('#quantity').value), unitPrice: parseFloat($('#unit-price').value) }; if (!d.itemId) return alert("الرجاء اختيار كتاب."); addOrUpdateOperation(d, 'print'); });
            app.forms.withdrawal.addEventListener('submit', e => { e.preventDefault(); const d = { id: $('#edit-withdrawal-id').value, date: $('#withdrawal-date').value, amount: parseFloat($('#withdrawal-amount').value), notes: $('#withdrawal-notes').value }; if(!(d.amount > 0)) return alert("الرجاء إدخال مبلغ صحيح."); addOrUpdateOperation(d, 'withdrawal'); });
            app.forms.password.addEventListener('submit', e => { e.preventDefault(); const o = $('#old-password').value, n = $('#new-password').value, c = $('#confirm-new-password').value; if(o !== getPassword()) return alert("كلمة المرور القديمة غير صحيحة."); if(n.length < 3) return alert("كلمة المرور الجديدة قصيرة جداً."); if(n !== c) return alert("كلمتا المرور الجديدتان غير متطابقتين."); setPassword(n); alert("تم تغيير كلمة المرور بنجاح!"); closeModal(app.modals.password); });
            
            $('#transactions-table-body').addEventListener('click', handleTableClick);
            app.dateFilter.addEventListener('change', handleDateFilterChange);
            app.bookSearchInput.addEventListener('keyup', renderBookReport); 
            $('#start-date').addEventListener('change', refreshFilteredUI);
            $('#end-date').addEventListener('change', refreshFilteredUI);

            $('#export-btn').addEventListener('click', () => exportToExcel());
            $('#import-file').addEventListener('change', handleImport);
            $('#analyze-report-btn').addEventListener('click', getFinancialAnalysis);
        };
        
        const switchView = (viewName) => {
            const views = { dashboard: $('#dashboard-view'), transactions: $('#transactions-view'), bookReport: $('#book-report-view') };
            const btns = { dashboard: $('#show-dashboard-btn'), transactions: $('#show-transactions-btn'), bookReport: $('#show-book-report-btn') };
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(btns).forEach(b => { b.classList.remove('text-cyan-600', 'bg-cyan-100'); b.classList.add('text-stone-600', 'hover:text-cyan-600', 'hover:bg-cyan-50'); });
            views[viewName].classList.remove('hidden');
            btns[viewName].classList.add('text-cyan-600', 'bg-cyan-100');
        };

        function excelDateToJSDate(serial) { if (typeof serial === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(serial)) { return serial; } if(typeof serial !== 'number') return null; const utc_days  = Math.floor(serial - 25569); const utc_value = utc_days * 86400; const date_info = new Date(utc_value * 1000); return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate() + 1).toISOString().split('T')[0]; }

        const generateBookQuantityReport = (ops) => {
            const summary = {};
            ops.filter(op => op.type === 'print').forEach(op => {
                const itemName = allItems.find(i => i.id === op.itemId)?.name || 'كتاب محذوف';
                if (!summary[itemName]) {
                    summary[itemName] = 0;
                }
                summary[itemName] += (op.quantity || 0);
            });

            return Object.entries(summary).map(([name, quantity]) => ({
                "اسم الكتاب": name,
                "الكمية المطبوعة": quantity
            })).sort((a,b) => b["الكمية المطبوعة"] - a["الكمية المطبوعة"]);
        };

        const exportToExcel = () => {
            showLoader('جاري تصدير الملف...');
            const opsToExport = getOperationsByPeriod();
            
            const formattedOps = opsToExport.map(op => {
                const opCopy = {...op};
                if (op.type === 'print') {
                    opCopy.itemName = allItems.find(i => i.id === op.itemId)?.name || 'N/A';
                }
                return opCopy;
            });

            const opsSheet = XLSX.utils.json_to_sheet(formattedOps);
            const itemsSheet = XLSX.utils.json_to_sheet(allItems);
            const quantityReport = generateBookQuantityReport(opsToExport);
            const quantitySheet = XLSX.utils.json_to_sheet(quantityReport);
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, opsSheet, "العمليات المفصلة");
            XLSX.utils.book_append_sheet(wb, quantitySheet, "تقرير الكميات");
            XLSX.utils.book_append_sheet(wb, itemsSheet, "قائمة الكتب الكاملة");

            const selectedOption = app.dateFilter.options[app.dateFilter.selectedIndex].text;
            XLSX.writeFile(wb, `تقرير_${selectedOption}_${new Date().toISOString().split('T')[0]}.xlsx`);
            hideLoader();
        };

        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                showLoader('جاري قراءة الملف...');
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    if (!workbook.SheetNames.includes("العمليات المفصلة") || !workbook.SheetNames.includes("قائمة الكتب الكاملة")) throw new Error("الملف يجب أن يحتوي على صفحتي 'العمليات المفصلة' و 'قائمة الكتب الكاملة'.");
                    const newOps = XLSX.utils.sheet_to_json(workbook.Sheets["العمليات المفصلة"]);
                    const newItems = XLSX.utils.sheet_to_json(workbook.Sheets["قائمة الكتب الكاملة"]);
                    
                    newOps.forEach(op => { op.date = excelDateToJSDate(op.date); });

                    hideLoader();
                    showConfirmation("تأكيد الاستيراد", "سيتم استبدال جميع البيانات الحالية ببيانات من الملف. هل أنت متأكد؟", () => { 
                        showLoader('جاري استيراد البيانات...'); 
                        allOperations = newOps; 
                        allItems = newItems; 
                        recalculateAllData(); 
                        $('#import-file').value = ''; 
                    });
                } catch (err) { hideLoader(); alert("خطأ في قراءة الملف: " + err.message); $('#import-file').value = ''; }
            };
            reader.readAsArrayBuffer(file);
        };
        
        const initApp = () => { 
            showLoader(); 
            loadData();
            $('#end-date').value = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            $('#start-date').value = oneMonthAgo.toISOString().split('T')[0];
            recalculateAllData(); 
            switchView('dashboard'); 
        };
        setupEventListeners();
    });
    </script>
</body>
</html>
